<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}" lang="ko">

<th:block layout:fragment="css">
    <head>
        <link rel="stylesheet" type="text/css" th:href="@{/static/css/board/common.css}"/>
        <link rel="stylesheet" type="text/css" th:href="@{/static/css/board/list.css}"/>
        <title>결재 발신함</title>
    </head>
</th:block>

<th:block layout:fragment="content">
    <div id="main_wrapper">
        <h1>결재 발신함</h1>
    </div>
    <div id="content_wrapper">
        <div id="search_wrapper" class="bg-secondary p-1">
            <caption>검색</caption>
            <p>
                <span th:text="날짜"/>
                <select id="searchDateType" th:field="*{searchDateRangeOptionList}" th:onchange="'fnOnChangeHandler(this)'">
                    <option th:each="ele : ${searchDateRangeOptionList}" th:value="${ele.getCode()}" th:text="|${ele.getDisplayName()}|"></option>
                </select>

                <label for="sDate">시작일
                    <input type="text" id="sDate" name="sDate">
                </label>
                <label>~</label>
                <label for="eDate">종료일
                    <input type="text" id="eDate" name="eDate">
                </label>

                <span th:text="진행상태"></span>
                <select id="searchStateTypeOptionList" th:field="*{searchStateTypeOptionList}">
                    <option th:each="ele : ${searchStateTypeOptionList}" th:value="${ele.getCode()}" th:text="|${ele.getDisplayName()}|"></option>
                </select>
            </p>

            <p>
                <span th:text="검색"></span>
                <select id="searchKeywordType" th:field="*{searchKeywordTypeOptionList}" th:onchange="'fnOnChangeHandler(this)'">
                    <option th:each="ele : ${searchKeywordTypeOptionList}" th:value="${ele.getCode()}" th:text="|${ele.getDisplayName()}|"></option>
                </select>
                <input type="text" name="searchWord1">
                <input type="button" th:value="검색" th:onclick="'fnSearchList(1, '+ ${paging.getDisplayRow()} + ', ' + ${totalCount} + ')'">
            </p>
        </div>

        <div id="list_wrapper" class="p-sm-2">
            <table id="rfrnc-table" class="table table-bordered text-center">
                <div>
                    <span id="totalCount" th:text="|전체 ${totalCount}개|"></span>
                    <select id="pageRowCriteria" th:onchange="'fnChangePageRowCriteria(1, ' + ${paging.getTotalCount()} + ')'">
                        <option th:selected="${paging.getDisplayRow()} == '10'" th:value="10" th:text="|10개|"></option>
                        <option th:selected="${paging.getDisplayRow()} == '20'" th:value="20" th:text="|20개|"></option>
                        <option th:selected="${paging.getDisplayRow()} == '30'" th:value="30" th:text="|30개|"></option>
                    </select>
                    <input id="excel-download" type="button" value="엑셀 다운로드(준비중)">
                    <input id="approve-delete" type="button" value="삭제" th:onclick="fnDeleteBoard()">
                    <input id="approve-write" type="button" value="전자결제 작성" onclick="location.href='/approve/registration'">
                </div>
                <thead>
                    <tr>
                        <th class="text-center" scope="col"><input type="checkbox" name="chkbox" id="chk_all" value="0" th:checked="false" th:onclick="'fnCheckboxHandler(this)'"></th>
                        <th class="text-center" scope="col">No</th>
                        <th class="text-center" scope="col">문서 제목</th>
                        <th class="text-center" scope="col">작성일</th>
                        <th class="text-center" scope="col">완료일</th>
                        <th class="text-center" scope="col">진행상태</th>
                    </tr>
                </thead>
                <tbody id="boardList">
                    <tr th:if="${not #lists.isEmpty(list)}" th:each="row, stat : ${list}">
                        <td>
                            <input type="checkbox" name="chkbox" th:checked="false" th:value="${row.getBoardSeq()}">
                        </td>
                        <td th:text="${row.getRowNum()}"></td>
                        <td><a th:href="@{'/board/' + ${row.getBoardSeq()}}" th:text="${row.getTitle()}"></a></td>
                        <td th:text="${row.getRegDtStr()}"></td>
                        <td th:text="${row.getCompleteDtStr()}"></td>
                        <td th:value="${row.getApproveState()}" th:text="${row.getApproveStateStr()}"></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(list)}">
                        <td class="no-row-found" colspan="9" th:text="|데이터가 없습니다.|"></td>
                    </tr>
                </tbody>
            </table>
            <nav aria-label="Page navigation" class="d-flex justify-content-center">
                <ul class="pagination">
                    <li class="page-item">
                        <a class="page-link" th:onclick="'fnSearchList(1, ' + ${paging.getDisplayRow()} + ', ' + ${totalCount} + ')'" href="#" aria-label="First">
                            <span aria-hidden="true">&laquo;</span>
                            <span class="sr-only">First</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" th:onclick="'fnSearchList(' + ${paging.getPrevPage()} + ', ' + ${paging.getDisplayRow()} + ', ' + ${totalCount} + ')'" href="#" aria-label="Previous">
                            <span aria-hidden="true">&lt;</span>
                            <span class="sr-only">Previous</span>
                        </a>
                    </li>
                    <li class="page-item" th:classappend="${page == paging.getCurrentPage()} ? 'active'" th:each="page: ${#numbers.sequence(paging.getBeginPage(), paging.getEndPage())}">
                        <a class="page-link" href="#" th:text="${page}" th:onclick="'fnSearchList(' + ${page} + ', ' + ${paging.getDisplayRow()} + ', ' + ${totalCount} + ')'">page number</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" th:onclick="'fnSearchList(' + ${paging.getNextPage()} + ', ' + ${paging.getDisplayRow()} + ', ' + ${totalCount} + ')'" href="#" aria-label="Next">
                            <span aria-hidden="true">&gt;</span>
                            <span class="sr-only">Next</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" th:onclick="'fnSearchList(' + ${paging.getTotalPage()} + ', ' + ${paging.getDisplayRow()} + ', ' + ${paging.getTotalCount()} + ')'" href="#" aria-label="Last">
                            <span aria-hidden="true">&raquo;</span>
                            <span class="sr-only">Last</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        let excelDownload = document.getElementById("excel-download");

        excelDownload.addEventListener("click", function(){
            let wb = XLSX.utils.table_to_book(document.getElementById("rfrnc-table"), {sheet: "sheet", raw:true});
            XLSX.writeFile(wb, ('게시판.xlsx'));
        });

        // 전체 체크박스 handler
        let fnCheckboxHandler = (chk_all) => {
            let checkboxes = document.getElementsByName('chkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = chk_all.checked;
            })
        }

        // 목록 조회
        let fnSearchList = (currentPage, displayRow, totalCount) => {
            // 날짜 조건 검증
            if($('#searchDateType option:selected').val() === 'REG_DT') {
                if($('#sDate').val() === '' || $('#eDate').val() === '') {
                    alert('검색할 날짜를 선택하세요.');
                    return false;
                }
            }

            // 검색어 조건 검증
            if($('#searchKeywordType option:selected').val() !== 'ALL') {
                if($('input[name=searchWord1]').val() === '') {
                    alert('검색어를 입력하세요.');
                    return false;
                }
            }

            const data = {
                boardPublicVO: {
                    // boardCd: "",
                    searchDateType: $('#searchDateType option:selected').val(),
                    startDt: $('#sDate').val(),
                    endDt: $('#eDate').val(),
                    searchKeywordType: $('#searchKeywordType option:selected').val(),
                    searchWord1: $('input[name=searchWord1]').val(),
                    approveState: $('#searchStateTypeOptionList option:selected').val()
                },
                paging: {
                    currentPage: currentPage,
                    displayRow: displayRow,
                    totalCount: totalCount
                }
            }

            $.ajax({
                url: '/approve/api/list',
                type: 'post',
                dataType: 'text',
                contentType: 'application/json; charset=UTF-8',
                data: JSON.stringify(data)
            })
            .done(function(data) {
                $('#list_wrapper').replaceWith(data);
            })
            .fail(function(jqXHR) {
                console.log(jqXHR);
            });
        }

        // 게시글 삭제
        let fnDeleteBoard = () => {
            let flag = true;
            let checkedList = [];
            $('input[name=chkbox]:checked').each(function() {
                let _approveState = $(this).parent().parent().find('td:eq(5)').attr('value');
                if(_approveState !== 'HDLE0404') {
                    alert('진행상태가 완료인 결재문서만 삭제가 가능합니다.');
                    flag = false;
                    return false;
                }
                checkedList.push(this.value);
            });

            if(flag) {
                if(checkedList.length < 1) {
                    alert('삭제 처리 하실 결재문서를 선택 해주세요.');
                    return false;
                }
                if(!confirm('선택된 결재문서를 삭제 처리 하시겠습니까?')) {
                    return false;
                }
                $.ajax({
                    url: '/approve/api/delete',
                    type: 'delete',
                    data: {lastId: 'ijzone', checkedList: checkedList}
                })
                    .done(function(data) {
                        alert(data.message);
                        fnSearchList(1, 10, 0);
                    })
                    .fail(function(jqXHR) {
                        console.log(jqXHR);
                    });
            }
        }

        // 게시글 갯수 선택에 따른 목록 조회
        let fnChangePageRowCriteria = (currentPage, totalCount) => {
            let displayRow = $('#pageRowCriteria option:selected').val();
            const data = {
                boardPublicVO: {
                    searchDateType: $('#searchDateType option:selected').val(),
                    startDt: $('#sDate').val(),
                    endDt: $('#eDate').val(),
                    searchKeywordType: $('#searchKeywordType option:selected').val(),
                    searchWord1: $('input[name=searchWord1]').val(),
                    boardCd: 'MENU0201'
                },
                paging: {
                    currentPage: currentPage,
                    displayRow: displayRow,
                    totalCount: totalCount,
                }
            }

            $.ajax({
                url: '/approve/api/list',
                type: 'post',
                dataType: 'text',
                contentType: 'application/json; charset=UTF-8',
                data: JSON.stringify(data)
            })
            .done(function(data) {
                $('#list_wrapper').replaceWith(data);
                console.log(data);
            })
            .fail(function(jqXHR) {
                console.log(jqXHR);
            });
        }

        // on change event handler
        let fnOnChangeHandler = (t, id, opt1, opt2) => {
            const _this = $(t);
            if(_this.val() === 'ALL') {
                _this.val('ALL').prop('selected', true);

                if(_this.attr('id') === 'searchDateType') {
                    $('#sDate').val('');
                    $('#eDate').val('');
                }else if(_this.attr('id') === 'searchKeywordType') {
                    $('input[name=searchWord1]').val('');
                }
            }
        }
    </script>
</th:block>
</html>