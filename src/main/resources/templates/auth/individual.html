<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}" lang="ko">

<th:block layout:fragment="css">
    <head>
        <link rel="stylesheet" type="text/css" th:href="@{/static/css/auth/common.css}"/>
        <title>개인 권한 관리</title>
    </head>
</th:block>

<th:block layout:fragment="content">
    <div id="main_wrapper">
        <h1>개인 권한 관리</h1>
    </div>
    <div id="content_wrapper">
        <div id="search_wrapper" class="bg-secondary p-lg-5">
            <span th:text="회원"/>
            <input type="button" value="회원 선택" th:onclick="fnSearchUserList()">
        </div>

        <div id="action_wrapper" class="m-lg-2">
            <input type="button" value="엑셀 업로드(준비중)">
            <input type="button" value="권한 저장" th:onclick="fnSaveAuthority()">
        </div>

        <div id="list_wrapper" class="p-sm-2">
            <table class="table table-bordered text-center">
                <thead>
                    <tr>
                        <th class="text-center" scope="col">No</th>
                        <th class="text-center" scope="col">카테고리명</th>
                        <th class="text-center" scope="col">세부 메뉴</th>
                        <th class="text-center" scope="col">메뉴 노출 여부</th>
                        <th class="text-center" scope="col">권한 레벨</th>
                    </tr>
                </thead>
                <tbody id="authList" th:object="${code}">
                    <tr th:class="auth-row" th:if="${not #lists.isEmpty(list)}" th:each="row, stat : ${list}" th:value="${row.getCodeCd()}">
                        <input type="hidden" name="_codeCd" th:value="${row.getCodeCd()}">
                        <input type="hidden" name="_codeOrd" th:value="${row.getCodeOrd()}">
                        <td th:text="${row.getRowNum()}"></td>
                        <td th:value="${row.getParentCodeCd()}" th:text="${row.getParentCodeNm()}"></td>
                        <td th:text="${row.getCodeNm()}"></td>
                        <td>
                            <input type="checkbox" th:field="*{displayUseYn}" th:value="*{displayUseYn}">
                            <label th:for="${#ids.prev('displayUseYn')}">노출</label>
                        </td>
                        <td>
                            <input type="checkbox" th:field="*{authR}" th:data-code-cd="${row.codeCd}" th:value="*{authR}">
                            <label th:for="${#ids.prev('authR')}">조회</label>

                            <input type="checkbox" th:field="*{authC}" th:data-code-cd="${row.codeCd}" th:value="*{authC}">
                            <label th:for="${#ids.prev('authC')}">저장</label>

                            <input type="checkbox" th:field="*{authU}" th:data-code-cd="${row.codeCd}" th:value="*{authU}">
                            <label th:for="${#ids.prev('authU')}">수정</label>

                            <input type="checkbox" th:field="*{authD}" th:data-code-cd="${row.codeCd}" th:value="*{authD}">
                            <label th:for="${#ids.prev('authD')}">삭제</label>

                            <input type="checkbox" th:field="*{authF}" th:data-code-cd="${row.codeCd}" th:value="*{authF}">
                            <label th:for="${#ids.prev('authF')}">파일</label>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(list)}">
                        <td class="no-row-found" colspan="5" th:text="|데이터가 없습니다.|"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="modalContainer" class="hidden">
        <div id="modal_detail_wrapper">
            <div>
                <span><b>회원 선택</b></span><span class="glyphicon glyphicon-remove" id="modalCloseButton" th:onclick="'fnModalHandler(this, 0)'"></span>
            </div>
            <div class="modal_search_wrapper">
                <p>
                    <span th:text="검색"></span>
                    <input type="text" name="searchKeyword" id="">
                    <input type="button" value="검색">
                    <input type="button" value="초기화">
                </p>
            </div>
            <div id="user_list_wrapper" class="row">
                <div class="left_wrapper bg-dark-subtle col-md-6">
                    <p th:each="user : ${users}" th:class="left-list">
                        <span th:text="${user.getUserNm()} + ' ' + ${user.getPositionNm()} + ' / ' + ${user.getAppointNm()} + ' ' + ${user.getDeptNm()}"></span>
                    </p>
                </div>
                <div id="modal_action_wrapper" class="col-md-3">
                    <span class="glyphicon-arrow-right"></span>
                    <span class="glyphicon-arrow-left"></span>
                    <span class="glyphicon-refresh"></span>
                </div>
                <div class="right_wrapper col-md-6">
                    <p th:each="user : ${users}" th:class="left-list">
                        <span th:text="${user.getUserNm()} + ' ' + ${user.getPositionNm()} + ' / ' + ${user.getAppointNm()} + ' ' + ${user.getDeptNm()}"></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

</th:block>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        // 사용자 조회
        let fnSearchUserList = () => {
            let _searchKeyword = $('input[name=searchKeyword]').val();
            $.ajax({
                url: '/auth/auth-popup',
                type: 'get',
                contentType: 'application/json; charset=UTF-8',
                data: {searchKeyword: _searchKeyword}
            })
            .done(function(data) {
                console.log(data);
                $('#modalContainer').removeClass('hidden');
                $('#user_list_wrapper').replaceWith(data);
            })
            .fail(function(jqXHR) {
                console.log(jqXHR);
            });
        }

        // 권한 저장
        let fnSaveAuthority = () => {
            const tgtList = [];
            const authList = $('.auth-row');
            const userList = [];
            userList.push("ijzone1");
            userList.push("ijzone2");
            userList.push("ijzone3");

            Array.from(authList).forEach(auth => {
                // console.log(auth);
                let data = {
                      menuCd: $(auth).find('input[name=_codeCd]').val()
                    , menuOrd: $(auth).find('input[name=_codeOrd]').val()
                    , authC: $(auth).find('input[name=authC]').is(':checked') == true ? 'Y' : 'N'
                    , authR: $(auth).find('input[name=authR]').is(':checked') == true ? 'Y' : 'N'
                    , authU: $(auth).find('input[name=authU]').is(':checked') == true ? 'Y' : 'N'
                    , authD: $(auth).find('input[name=authD]').is(':checked') == true ? 'Y' : 'N'
                    , authF: $(auth).find('input[name=authF]').is(':checked') == true ? 'Y' : 'N'
                    , displayUseYn: $(auth).find('input[name=displayUseYn]').is(':checked') == true ? 'Y': 'N'
                    , userIdList: userList
                }
                tgtList.push(data);
            })

            $.ajax({
                url: '/auth/individual/api',
                type: 'post',
                contentType: 'application/json; charset=UTF-8',
                data: JSON.stringify(tgtList)
            })
            .done(function(data) {
                alert(data.message);
                $('input[type=checkbox]').each(function() {
                    this.checked = false;
                })
            })
            .fail(function(jqXHR) {
                console.log(jqXHR);
            });
        }

        // 체크박스 handler
        $('input[type=checkbox]').on('click', function() {
            const _this = $(this);
            let _authLevel = $(this).attr('name');
            // $(this).siblings('input[name=authU]').is(':checked')
            if(_authLevel === 'authR') {
                if(!_this.siblings('input[name=authR]').is(':checked')) {
                    _this.siblings('input[name=authC]').prop('checked', false);
                    _this.siblings('input[name=authU]').prop('checked', false);
                    _this.siblings('input[name=authD]').prop('checked', false);
                }
            }
            if(_authLevel === 'authC') {
                if(!_this.siblings('input[name=authC]').is(':checked')) {
                    _this.siblings('input[name=authU]').prop('checked', false);
                    _this.siblings('input[name=authD]').prop('checked', false);
                }

                if(!_this.siblings('input[name=authR]').is(':checked')) {
                    _this.siblings('input[name=authR]').prop('checked', true);
                }
            }
            if(_authLevel === 'authU') {
                if(!_this.siblings('input[name=authU]').is(':checked')) {
                    _this.siblings('input[name=authD]').prop('checked', false);
                }

                if(!_this.siblings('input[name=authR]').is(':checked') || !_this.siblings('input[name=authC]').is(':checked')) {
                    _this.siblings('input[name=authR]').prop('checked', true);
                    _this.siblings('input[name=authC]').prop('checked', true);
                }
            }
            if(_authLevel === 'authD') {
                if(!_this.siblings('input[name=authR]').is(':checked') || !_this.siblings('input[name=authC]').is(':checked') || !_this.siblings('input[name=authU]').is(':checked')) {
                    _this.siblings('input[name=authR]').prop('checked', true);
                    _this.siblings('input[name=authC]').prop('checked', true);
                    _this.siblings('input[name=authU]').prop('checked', true);
                }
            }
        })

        let fnModalHandler = (t, f) => {
            if(f === 0) {
                $('#modalContainer').addClass('hidden');
            }else {
                $('#modalContainer').removeClass('hidden');
            }
        }
    </script>
</th:block>
</html>